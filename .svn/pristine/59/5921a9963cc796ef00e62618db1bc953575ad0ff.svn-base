package com.desksoft.wechat.controller.user;

import java.util.Date;
import java.util.Map;

import com.desksoft.wechat.common.model.PayRecord;
import com.desksoft.wechat.common.model.RefeeFlow;
import com.desksoft.wechat.common.model.ScoreFlow;
import com.desksoft.wechat.common.model.User;
import com.desksoft.wechat.common.model.UserBindFlow;
import com.desksoft.wechat.controller.BaseController;
import com.jfinal.aop.Before;

public class UserController extends BaseController {
	
	@Before(UserValidator.class)
	public void login(){
		// 获取用户名
		String username = getPara("username");
        // 获取密码
		String password = getPara("password");

		Map<String, Object> map = User.dao.getUserByNamePasswd(username, password);

        if ((boolean)map.get("flag")) {
            // 保存session
            getSession().setAttribute(USER_SESSION_KEY, User.dao.getUserByUserName(username));
        } 
        	
        setAttr("data", map);
        // 跳转到前台发起请求的路径
        renderJson();
	}
	
	public void tologin(){
		render("login.html");
	}
	public void logout(){
		//int userid = getParaToInt(0,1);
		 getSession().setAttribute(USER_SESSION_KEY, null);
		 redirect("login.html");
	}
	
	public void getBindingUserList(){
		Date startDate = getQueryDate("startDate");
		Date endDate = getQueryDate("endDate");				
		int userNo = getParaToInt("userNo",0);
		setAttr("userNo",userNo);
		setAttr("prjPage", UserBindFlow.me.getBindingUserPaginateList(getParaToInt("pageIndex", 1), 10,startDate,endDate,userNo));
		render("bindingUserPageList.html");
	}
	
	public void getPayRecordList(){
		Date startDate = getQueryDate("startDate");
		Date endDate = getQueryDate("endDate");				
		int userNo = getParaToInt("userNo",0);
		setAttr("userNo",userNo);
		setAttr("prjPage", PayRecord.dao.getPayRecordPaginateList(getParaToInt("pageIndex", 1), 10,startDate,endDate,userNo));
		render("payRecordPageList.html");
	}
	
	public void getRefeeFlowList() {
		Date startDate = getQueryDate("startDate");
		Date endDate = getQueryDate("endDate");
		String openID = getPara("openID","default");
		setAttr("openID", openID);
		setAttr("prjPage",RefeeFlow.dao.getRefeeFlowPaginateList(getParaToInt("pageIndex", 1), 10, startDate, endDate, openID));
		render("getRefeeFlowList.html");
	}
	
	public void getScoreFlowList() {
		Date startDate = getQueryDate("startDate");
		Date endDate = getQueryDate("endDate");
		String openID = getPara("openID","default");
		setAttr("openID", openID);
		setAttr("prjPage",ScoreFlow.dao.getScoreFlowPaginateList(getParaToInt("pageIndex", 1), 10, startDate, endDate, openID));
		render("getScoreFlowList.html");
	}
	
//	@ActionKey("/user/delBindingUser")
//	public void delBindingUser() {
//		UserBindFlow.me.delBindingUser(getParaToInt());
//		redirect("/user/getBindingUserList");
//	}
	
	/*public void  addUser(){
		//String userName = getPara(0);
		//String password = getPara(1);
		String remark = PasswordUtil.getRandomOperPassword();
		String password = PasswordUtil.getEncyptedOperPassword("111111", remark);
		new User().set("username", "admin").set("type", 2).set("remark", remark).set("password", password).save();
	}*/
}
