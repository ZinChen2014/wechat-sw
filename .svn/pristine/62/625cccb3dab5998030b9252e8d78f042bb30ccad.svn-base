package com.desksoft.wechat.service;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;
import java.net.UnknownHostException;
import java.text.SimpleDateFormat;
import java.util.Date;

/**
 * 优普 自来水内部系统socket调用接口
 * @author Joker
 *
 */
public class YouPuSocketService {

	// 接口ip
	private static final String ip = "60.190.200.54";

	// 接口port
	private static final int port = 8002;

	public static void main(String[] args) {

		split("我ABC汗dd", 7);
		// 户号
		String userNo = "5962";//810023
		/*String orderNo = "A20160103100909-90011116";
		String realPay = "31.20";
		String payDate = "2016-01-03";*/
		//充值
		//getRePayData(userNo, orderNo, realPay, payDate);
		/*String accountDate = "2016-03-16";
		String fileName = "SZWX0120160316.DZ";
		String length = "89";
		
		getChkAccountData(accountDate, fileName, length);*/
		
		
		//用户信息查询 ，用于绑定
		// getUserInfoData(userNo);
		//我的用水情况
		//getUserWaterInfo(userNo,null,null);
		//欠费情况
		//getpayData(userNo,null,null);
		//缴费确认 
	/*		orderNo = "A20160103100909-90011116";
		String realNumber = "1";
		String realAddr = "WX";
		 realPay = "31.20";
		String  realWorkNo = "9994";
		 payDate = "2016-01-03";
		 String feeID = "2816206";*/
		// getchkpay(orderNo, realNumber, realAddr, realPay, realWorkNo, payDate, feeID);
		//冲正
		//getFlushes(userNo, userNo, userNo);
		
		//System.out.println(ScoketCode.c00.getValue());
	}

	public static void split(String temp,int num){
		int k=0;
		String temp1="";
		for(int i=0;i<temp.length();i++){
			byte[] b=(temp.charAt(i)+"").getBytes();
			k= k+b.length;
			if(k>num){
				break;
			}
			temp1=temp1+temp.charAt(i);
		}
		System.out.println(temp1);
	}
	
	/**
	 * 
	 * @param code
	 *            交易码
	 * @param length
	 *            报文体长度
	 * @return 报文头
	 */
	private static String getReportHead(String code, int length) {
		// 银行代码
		String bankCode = "SZWX01";
		//
		// 交易日期
		SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
		String time = sdf.format(new Date());
		//String time = "20160103";
		// 报文长度 自动填充12位
		String strLength = String.format("%012d", length);
		// 报文头
		String senderHead = code + bankCode + time + strLength + "000000000000" + "  " + "                  ";
		return senderHead;
	}

	/**
	 * 接口调用
	 * 
	 * @param sendData
	 * @return 
	 */
	private static String getSocketCallbackStr(String sendData) {

		String temp = "";
		byte[] data = sendData.getBytes();
		Socket socket = null;
		try {
			socket = new Socket(ip, port);
			InputStream in = socket.getInputStream();
			OutputStream out = socket.getOutputStream();
			out.write(data);
			// receive
			byte[] recdata = new byte[2000];
			in.read(recdata);
			System.out.println("recv:" + new String(recdata, "gb2312"));
			temp = new String(recdata, "gb2312");
		} catch (UnknownHostException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		} finally {
			try {
				if (socket != null) {
					socket.close();
				}
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
		return temp;
	}

	/**
	 * 用户信息查询 1002
	 * 
	 * @param userNo
	 * @return  String
	 */
	public static String getUserInfoData(String userNo) {
		// 交易码
		String code = "1002";
		String senderHead = getReportHead(code, userNo.length());
		String senderStr = senderHead + "|" + userNo;
		return getSocketCallbackStr(senderStr);
	}


	/**
	 * 1001缴费申请 ：查询欠费信息
	 * 
	 * @param userNo  户号
	 * @param startDate  开始日期
	 * @param endDate  结束日期
	 * @return
	 */
	public static String getpayData(String userNo, String startDate, String endDate) {
	 //if(StrKit.isBlank(startDate)){ startDate = "2016-01"; }
		// 交易码
		String code = "1001";
		//报文体
		String temp = userNo + "|" + startDate + "|" + endDate;
		// 报文头
		String senderHead = getReportHead(code, temp.length());
		String senderStr = senderHead + "|" + temp;
		System.out.println(senderStr);
		return getSocketCallbackStr(senderStr);
	}

	/**
	 * 1003用水情况 默认是一年 最近一年
	 * 
	 * @param userNo 户号
	 * @param startDate
	 * @param endDate
	 * @return
	 */
	public static String getUserWaterInfo(String userNo, String startDate, String endDate) {
		// 交易码
		String code = "1003";
		String temp = userNo + "|" + startDate + "|" + endDate;
		// 报文头
		String senderHead = getReportHead(code, temp.length());
		String senderStr = senderHead + "|" + temp;
		System.out.println(senderStr);
		return getSocketCallbackStr(senderStr);
	}

	/**
	 * 2001 缴费确认
	 * 
	 * @param orderNo 进账流水号
	 * @param realNumber 笔数
	 * @param realAddr 水表安装地址
	 * @param realPay  实收费
	 * @param realWorkNo 工号
	 * @param payDate 收费日期
	 * @param feeID  收费ID
	 * @return
	 */
	public static String getchkpay(String orderNo, String realNumber, String realAddr, String realPay,
			String realWorkNo, String payDate, String feeID) {
		// 交易码
		String code = "2001";

		String temp = orderNo + "|" + realNumber + "|" + realAddr + "|" 
		+ realPay + "|" + realWorkNo + "|" + payDate + "|" + feeID;
		
		// 报文头
		String senderHead = getReportHead(code, temp.length());
		String senderStr = senderHead + "|" + temp;
		return getSocketCallbackStr(senderStr);
	}
	
	/**
	 * 2002 冲正 //毙掉
	 * 
	 * @param orderNo
	 * @param realPay
	 * @param payDate
	 * @return
	 */
	private static String getFlushes (String orderNo,String realPay, String payDate) {
		// 交易码
		String code = "2002";
		String temp = realPay  + "|"+ orderNo  + "|" + payDate ;
		
		// 报文头
		String senderHead = getReportHead(code, temp.length());
		String senderStr = senderHead + "|" + temp;
		System.out.println("send:"+senderStr);
		return getSocketCallbackStr(senderStr);
	}
	
	/**
	 *  2003 充值
	 * 
	 * @param userId 客户号
	 * @param orderNo 进账流水
	 * @param realPay 实收款
	 * @param payDate 收款日期
	 * @return
	 */
	public static String getRePayData(String userId, String orderNo,  String realPay,String payDate) {
		// 交易码
		String code = "2003";
		String temp = userId + "|" + orderNo + "|" + realPay + "|" + payDate ;
		
		// 报文头
		String senderHead = getReportHead(code, temp.length());
		String senderStr = senderHead + "|" + temp;
		return getSocketCallbackStr(senderStr);
	}
	
	/**
	 * 缴费对账 2004
	 * 
	 * @param accountDate 对账日期(清算日)
	 * @param fileName  对账文件名称
	 * @param length  对账文件长度
	 * @return
	 */
	public static String getChkAccountData(String accountDate, String fileName,  String length) {
		// 交易码
		String code = "2004";
		String temp = accountDate + "|" + fileName + "|" + length ;
		
		// 报文头
		String senderHead = getReportHead(code, temp.length());
		String senderStr = senderHead + "|" + temp;
		System.out.println("send:"+senderStr);
		return getSocketCallbackStr(senderStr);
	}
	
	
}
